<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; margin: 0; }
        h1 { text-align: center; color: #1a2c5b; }
        .nav-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; font-weight: bold; }
        .nav-container a { color: #007bff; text-decoration: none; }
        .nav-container a:hover { text-decoration: underline; }
        .filter-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-width: 600px; margin-left: auto; margin-right: auto; flex-wrap: wrap; }
        .charts-wrapper { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 10px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0px 4px 12px rgba(0,0,0,0.08); }
        @media (max-width: 900px) { .charts-wrapper { grid-template-columns: 1fr; } }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease; }
        .loader-spinner { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="loader" class="loader-overlay"><div class="loader-spinner"></div></div>
    <h1>ðŸ“Š Dashboard de Vendas</h1>
    <div class="nav-container">
        <a href="/">Dashboard Geral</a>
        <a href="/contas-a-receber">Contas a Receber</a>
        <a href="/contas-a-pagar">Contas a Pagar</a>
    </div>
    <div class="filter-container">
        <label for="start_date">De:</label><input type="date" id="start_date">
        <label for="end_date">AtÃ©:</label><input type="date" id="end_date">
        <button id="filter-button">Filtrar</button>
    </div>
    <div class="charts-wrapper">
        <div class="chart-container"><h2>Totais Mensais</h2><canvas id="chartMensal"></canvas></div>
        <div class="chart-container"><h2>EvoluÃ§Ã£o das Vendas (DiÃ¡rio)</h2><canvas id="chartLinha"></canvas></div>
        <div class="chart-container"><h2>Top 5 Clientes</h2><canvas id="chartClientes"></canvas></div>
        <div class="chart-container"><h2>Top 10 Produtos Mais Vendidos</h2><canvas id="chartProdutos"></canvas></div>
    </div>
    <script>
        // O JavaScript para carregar os grÃ¡ficos de vendas permanece o mesmo do arquivo index.html anterior
        const loader = document.getElementById('loader');
        let chartInstances = {};
        function destroyChart(chartId) { if (chartInstances[chartId]) chartInstances[chartId].destroy(); }
        async function fetchDataAndCreateCharts() {
            loader.classList.remove('loader-hidden');
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const urlParams = new URLSearchParams({ start_date: startDate, end_date: endDate }).toString();
            try {
                await Promise.all([
                    carregarTotaisMensais(urlParams), carregarEvolucaoVendas(urlParams),
                    carregarClienteTop(urlParams), carregarProdutosTop(urlParams)
                ]);
            } catch (error) { console.error("Falha ao carregar dados:", error); } 
            finally { loader.classList.add('loader-hidden'); }
        }
        async function carregarTotaisMensais(urlParams) {
            const response = await fetch(`/totais-mensais?${urlParams}`); const data = await response.json();
            const ctx = document.getElementById('chartMensal').getContext('2d'); destroyChart('chartMensal');
            chartInstances.chartMensal = new Chart(ctx, { type: 'bar', data: { labels: data.map(item => `${item.ano}-${String(item.mes).padStart(2, '0')}`), datasets: [{ label: 'Vendas', data: data.map(item => item.total_vendas), backgroundColor: 'rgba(54, 162, 235, 0.7)', yAxisID: 'y' }, { label: 'Compras', data: data.map(item => item.total_compras), backgroundColor: 'rgba(255, 99, 132, 0.7)', yAxisID: 'y1' }] }, options: { responsive: true, scales: { y: { position: 'left', title: { display: true, text: 'Total de Vendas (R$)'}}, y1: { position: 'right', title: { display: true, text: 'Total de Compras (R$)'}, grid: { drawOnChartArea: false }} } } });
        }
        async function carregarEvolucaoVendas(urlParams) {
            const response = await fetch(`/serie-diaria?${urlParams}`); const data = await response.json();
            const ctx = document.getElementById('chartLinha').getContext('2d'); destroyChart('chartLinha');
            chartInstances.chartLinha = new Chart(ctx, { type: 'line', data: { labels: data.map(item => item.data), datasets: [{ label: 'Vendas DiÃ¡rias', data: data.map(item => item.total_vendas), borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 }] } });
        }
        async function carregarClienteTop(urlParams) {
            const response = await fetch(`/cliente-top?${urlParams}`); const data = await response.json();
            const top5 = data.slice(0, 5);
            const ctx = document.getElementById('chartClientes').getContext('2d'); destroyChart('chartClientes');
            chartInstances.chartClientes = new Chart(ctx, { type: 'bar', data: { labels: top5.map(item => item.Razao_Social), datasets: [{ label: 'Total Gasto (R$)', data: top5.map(item => item.total_gasto), backgroundColor: 'rgba(153, 102, 255, 0.7)' }] }, options: { indexAxis: 'y' } });
        }
        async function carregarProdutosTop(urlParams) {
            const response = await fetch(`/produtos-top?${urlParams}`); const data = await response.json();
            const ctx = document.getElementById('chartProdutos').getContext('2d'); destroyChart('chartProdutos');
            chartInstances.chartProdutos = new Chart(ctx, { type: 'bar', data: { labels: data.map(item => item.descricao), datasets: [{ label: 'Quantidade Vendida', data: data.map(item => item.total_vendido), backgroundColor: 'rgba(255, 159, 64, 0.7)' }] }, options: { plugins: { legend: { display: false } } } });
        }
        document.getElementById('filter-button').addEventListener('click', fetchDataAndCreateCharts);
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date(); const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            const formatDate = (date) => date.toISOString().split('T')[0];
            document.getElementById('start_date').value = formatDate(firstDayOfYear); document.getElementById('end_date').value = formatDate(today);
            fetchDataAndCreateCharts();
        });
    </script>
</body>
</html>